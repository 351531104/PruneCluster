var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},PruneCluster;!function(a){function b(a,b){return a.lat>=b.minLat&&a.lat<=b.maxLat&&a.lng>=b.minLng&&a.lng<=b.maxLng}function c(a){for(var b,c,d,e=1,f=a.length;f>e;++e){for(c=a[e],d=c.position.lng,b=e-1;b>=0&&a[b].position.lng>d;--b)a[b+1]=a[b];a[b+1]=c}}var d=.2,e=function(){function a(){}return a}();a.Point=e;var f=function(){function a(){}return a}();a.ClusterObject=f;var g=function(a){function b(b,c,d){"undefined"==typeof d&&(d={}),a.call(this),this.data=d,this.position={lat:b,lng:c},this.weight=1}return __extends(b,a),b.prototype.Move=function(a,b){this.position.lat=a,this.position.lng=b},b}(f);a.Marker=g;var h=function(a){function b(b){a.call(this),this.marker=b,this.stats={},this.data={},this.population=1,b.category&&(this.stats[b.category]=1),this._totalWeight=b.weight,this.position={lat:b.position.lat,lng:b.position.lng},this.averagePosition={lat:b.position.lat,lng:b.position.lng}}return __extends(b,a),b.prototype.AddMarker=function(a){this.marker=a;var b=a.weight,c=this._totalWeight,d=b+c;this.averagePosition.lat=(this.averagePosition.lat*c+a.position.lat*b)/d,this.averagePosition.lng=(this.averagePosition.lng*c+a.position.lng*b)/d,++this.population,this._totalWeight=d,a.category&&(this.stats.hasOwnProperty(a.category)?++this.stats[a.category]:this.stats[a.category]=1)},b.prototype.Reset=function(){this.marker=void 0,this.population=0,this._totalWeight=0},b.prototype.ComputeBounds=function(a){var b=a.Project(this.position.lat,this.position.lng),c=a.Size,d=Math.floor(b.x/c),e=Math.floor(b.y/c),f=d*c,g=e*c,h=a.UnProject(f,g),i=a.UnProject(f+c,g+c);this.bounds={minLat:i.lat,maxLat:h.lat,minLng:h.lng,maxLng:i.lng}},b}(f);a.Cluster=h;var i=function(){function a(){this._markers=[],this._nbChanges=0,this._clusters=[],this.Size=166,this.ViewPadding=.13}return a.prototype.RegisterMarker=function(a){this._markers.push(a),this._nbChanges+=1},a.prototype._sortMarkers=function(){var a=this._markers,b=a.length;this._nbChanges&&(!b||this._nbChanges/b>d)?this._markers.sort(function(a,b){return a.position.lng-b.position.lng}):c(a),this._nbChanges=0},a.prototype._sortClusters=function(){c(this._clusters)},a.prototype._indexLowerBoundLng=function(a){for(var b,c,d=this._markers,e=0,f=d.length;f>0;)c=Math.floor(f/2),b=e+c,d[b].position.lng<a?(e=++b,f-=c+1):f=c;return e},a.prototype._resetClusterViews=function(){for(var a=0,b=this._clusters.length;b>a;++a){var c=this._clusters[a];c.Reset(),c.ComputeBounds(this)}},a.prototype.ProcessView=function(a){var c=Math.abs(a.maxLat-a.minLat)*this.ViewPadding,d=Math.abs(a.maxLng-a.minLng)*this.ViewPadding,e={minLat:a.minLat-c-c,maxLat:a.maxLat+c+c,minLng:a.minLng-d-d,maxLng:a.maxLng+d+d};this._sortMarkers(),this._resetClusterViews();for(var f=this._indexLowerBoundLng(e.minLng),g=this._markers,i=this._clusters,j=0,k=f,l=g.length;l>k;++k){var m=g[k],n=m.position;if(n.lng>e.maxLng)break;if(n.lat>e.minLat&&n.lat<e.maxLat){for(var o,p=!1,q=j,r=i.length;r>q;++q)if(o=i[q],b(n,o.bounds)){o.AddMarker(m),p=!0;break}p||(o=new h(m),o.ComputeBounds(this),i.push(o))}}var s=[];for(k=0,l=i.length;l>k;++k)o=i[k],o.population>0&&s.push(o);return this._clusters=s,this._sortClusters(),this._clusters},a}();a.PruneCluster=i}(PruneCluster||(PruneCluster={}));var PruneCluster;!function(){}(PruneCluster||(PruneCluster={}));var PruneClusterForLeaflet=L.Class.extend({initialize:function(){var a=this;this.Cluster=new PruneCluster.PruneCluster,this.Cluster.Project=function(b,c){return a._map.project(new L.LatLng(b,c))},this.Cluster.UnProject=function(b,c){return a._map.unproject(new L.Point(b,c))},this._objectsOnMap=[]},RegisterMarker:function(a){this.Cluster.RegisterMarker(a)},BuildLeafletCluster:function(a,b){var c=this,d=new L.Marker(b,{icon:this.BuildLeafletClusterIcon(a)});return d.on("click",function(){c._map.fitBounds(new L.LatLngBounds(new L.LatLng(a.bounds.minLat,a.bounds.maxLng),new L.LatLng(a.bounds.maxLat,a.bounds.minLng)))}),d},BuildLeafletClusterIcon:function(a){var b="prunecluster prunecluster-";return b+=a.population<10?"small":a.population<100?"medium":"large",new L.DivIcon({html:"<div><span>"+a.population+"</span></div>",className:b,iconSize:L.point(40,40)})},BuildLeafletMarker:function(a,b){return new L.Marker(b)},onAdd:function(a){this._map=a,a.on("dragend",this.ProcessView,this),a.on("zoomstart",this._zoomStart,this),a.on("zoomend",this._zoomEnd,this),this.ProcessView()},onRemove:function(a){a.off("dragend",this.ProcessView,this),a.off("zoomstart",this._zoomStart,this),a.off("zoomend",this._zoomEnd,this);for(var b=0,c=this._objectsOnMap.length;c>b;++b)this._map.removeLayer(this._objectsOnMap[b])},_zoomStart:function(){this.disableProcessView=!0},_zoomEnd:function(){this.disableProcessView=!1,this.ProcessView()},ProcessView:function(){var a=this;if(!this.disableProcessView){var b=this._map,c=b.getBounds(),d=c.getSouthWest(),e=c.getNorthEast(),f=+new Date,g=this.Cluster.ProcessView({minLat:d.lat,minLng:d.lng,maxLat:e.lat,maxLng:e.lng});console.log("time: ",+new Date-f);for(var h=this._objectsOnMap,i=[],j=0,k=h.length;k>j;++j)h[j]._removeFromMap=!0;for(g.forEach(function(c){var d=void 0,e=new L.LatLng(c.averagePosition.lat,c.averagePosition.lng),f=c.data._leafletMarker;f&&(1===c.population&&1===c.data._leafletOldPopulation?(f.setLatLng(e),d=f):c.population>1&&c.data._leafletOldPopulation>1&&(f.setLatLng(e),f.setIcon(a.BuildLeafletClusterIcon(c)),c.data._leafletOldPopulation=c.population,d=f)),d||(d=1===c.population?a.BuildLeafletMarker(c.marker,e):a.BuildLeafletCluster(c,e),d.addTo(b),c.data._leafletMarker=d,c.data._leafletOldPopulation=c.population),d._removeFromMap=!1,i.push(d)}),j=0,k=h.length;k>j;++j)h[j]._removeFromMap&&b.removeLayer(h[j]),h[j]._removeFromMap=!0;this._objectsOnMap=i}}});
//# sourceMappingURL=PruneCluster.min.js.map